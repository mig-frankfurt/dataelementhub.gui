<template>
  <v-container fluid class="py-0 px-0 d-flex flex-column flex-grow-1 fill-parent-height align-start">
    <default-snackbar
      :text="$t('global.itemDialog.snackbar.deleteFailure') + ': ' + dialog.response.data"
      :show="snackbar.deleteFailure"
      color="error"
    />
    <default-snackbar
      :text="$t('global.itemDialog.snackbar.deleteSuccess')"
      :show="snackbar.deleteSuccess"
    />
    <default-snackbar
      :text="$t('global.itemDialog.snackbar.saveFailure') + ': ' + dialog.response.data"
      :show="snackbar.saveFailure"
      color="error"
    />
    <default-snackbar
      :text="$t('global.itemDialog.snackbar.saveSuccess')"
      :show="snackbar.saveSuccess"
    />
    <v-row no-gutters class="top-row flex-grow-0 flex-shrink-0">
      <v-col cols="2" class="create-namespace-col pa-3">
        <h4 class="text-h4 mb-2">
          {{ $t('global.mainMenu.namespaces') }}:
        </h4>
        <v-divider />
      </v-col>
      <v-col cols="2" class="create-namespace-col pa-3">
        <v-btn
          v-if="loggedIn"
          class="d-block mr-0 ml-auto"
          color="primary"
          rounded
          @click="dialog.elementType = 'NAMESPACE'; dialog.showNamespace = true"
        >
          <v-icon dark>
            mdi-plus
          </v-icon>
          {{ $t('global.button.create') }}
        </v-btn>
      </v-col>
      <v-col cols="8" class="detail-view-col" />
    </v-row>
    <v-row
      no-gutters
      class="bottom-row flex-grow-1 flex-shrink-1 align-stretch"
    >
      <v-col cols="4" class="auto-scroll tree-view-col pa-2">
        <div v-if="treeItems.length === 0" align="middle">
          <v-icon size="100">
            mdi-plus
          </v-icon>
          <h3 class="text-h2 mb-2">
            {{ $t('global.noItems') }}
          </h3>
          <h3 class="text-h6 mb-2">
            {{ $t('global.addNamespaces') }}
          </h3>
        </div>
        <v-treeview
          :key="componentKey"
          :v-model="treeItems"
          :active="activeElements"
          :open.sync="openNodes"
          :items="treeItems"
          :load-children="fetchMembers"
          multiple-active
          return-object
          activatable
          color="warning"
          rounded
          hoverable
          transition
          @update:active="setActiveElements"
        >
          <template #prepend="{ item }">
            <v-icon
              v-if="item.elementType === 'NAMESPACE'"
              color="white"
            >
              mdi-garage-variant
            </v-icon>
            <v-icon
              v-else-if="item.elementType === 'DATAELEMENT'"
              color="white"
            >
              mdi-vector-arrange-below
            </v-icon>
            <v-icon
              v-else-if="item.elementType === 'DATAELEMENTGROUP'"
              color="white"
            >
              mdi-group
            </v-icon>
            <v-icon
              v-else-if="item.elementType === 'RECORD'"
              color="white"
            >
              mdi-group
            </v-icon>
          </template>
          <template #append="{ item }">
            <AlertIcon
              v-if="!item.isPreferredLanguage"
              :title="$t('global.alerts.warning')"
              :alerts="[$t('global.alerts.defineLanguage')]"
            />
            <v-menu
              bottom
              offset-y
            >
              <template #activator="{ on, attrs }">
                <v-btn
                  v-if="item.elementType !== 'DATAELEMENT' && item.editable && loggedIn"
                  class="d-block mr-0 ml-auto"
                  rounded
                  v-bind="attrs"
                  v-on="on"
                >
                  <v-icon>mdi-plus</v-icon>
                  {{ $t('global.button.create') }}
                </v-btn>
              </template>
              <v-list>
                <v-list-item
                  v-for="(elementType, i) in ['DATAELEMENT', 'DATAELEMENTGROUP', 'RECORD']"
                  :key="i"
                  @click="() => {elementToBeCreated(elementType, item.urn)}"
                >
                  <v-list-item-title>
                    <v-icon>mdi-plus-box</v-icon>
                    {{ 'CREATE ' + elementType }}
                  </v-list-item-title>
                </v-list-item>
              </v-list>
            </v-menu>
          </template>
        </v-treeview>
      </v-col>
      <v-col cols="8" class="auto-scroll detail-view-col pa-6 pt-8">
        <div>
          <DataElementDetailView
            v-if="selected && selectedElement.identification.elementType === 'DATAELEMENT'"
            :urn="selectedElement.identification.urn"
            :parent-urn="activeElements.slice(-1)[0].parentUrn"
            :editable="loggedIn && selectedElement.editable"
            :deletable="loggedIn && selectedElement.editable"
            @save="updateTree($event); snackbar.saveSuccess = true"
            @saveFailure="handleSaveFailure($event)"
            @delete="updateTree(selectedElement) ; snackbar.deleteSuccess = true"
            @deleteFailure="handleDeleteFailure ($event)"
          />
          <GroupsRecordsDetailView
            v-if="selected && (selectedElement.identification.elementType === 'DATAELEMENTGROUP'
              || selectedElement.identification.elementType === 'RECORD' )"
            :urn="selectedElement.identification.urn"
            :parent-urn="activeElements.slice(-1)[0].parentUrn"
            :editable="loggedIn && selectedElement.editable"
            :deletable="loggedIn && selectedElement.editable"
            @save="snackbar.saveSuccess = true"
            @saveFailure="handleSaveFailure($event)"
            @reloadMembers="updateTree($event)"
            @delete="updateTree(selectedElement) ; snackbar.deleteSuccess = true"
            @deleteFailure="handleDeleteFailure ($event)"
          />
          <NamespaceDetailView
            v-if="selected && selectedElement.identification.elementType === 'NAMESPACE'"
            :urn="selectedElement.identification.urn"
            :editable="loggedIn && selectedElement.editable"
            :deletable="loggedIn && selectedElement.editable"
            @save="updateTree($event); snackbar.saveSuccess = true"
            @saveFailure="handleSaveFailure($event)"
            @delete="updateTree(selectedElement) ; snackbar.deleteSuccess = true"
            @deleteFailure="handleDeleteFailure ($event)"
          />
        </div>
      </v-col>
    </v-row>
    <v-row v-if="dialog.showDataElement || dialog.showDataElementGroup || dialog.showNamespace">
      <v-col>
        <NamespaceDialog
          v-if="dialog.elementType === 'NAMESPACE'"
          :id="0"
          :show="dialog.showNamespace"
          @save="updateTree($event); showSaveSuccessSnackbar()"
          @saveFailure="handleSaveFailure($event)"
          @dialogClosed="dialog.showNamespace = false"
        />
        <DataElementDialog
          v-if="dialog.elementType === 'DATAELEMENT'"
          :show="dialog.showDataElement"
          :namespace-urn="dialog.namespaceUrn"
          @save="updateTree($event); showSaveSuccessSnackbar()"
          @saveFailure="handleSaveFailure($event)"
          @dialogClosed="dialog.showDataElement = false"
        />
        <GroupRecordDialog
          v-if="(dialog.elementType === 'DATAELEMENTGROUP' || dialog.elementType === 'RECORD')"
          :show="dialog.showDataElementGroup"
          :namespace-urn="dialog.namespaceUrn"
          :element-type="dialog.elementType"
          @save="updateTree($event); showSaveSuccessSnackbar()"
          @saveFailure="handleSaveFailure($event)"
          @dialogClosed="dialog.showDataElementGroup = false"
        />
      </v-col>
    </v-row>
  </v-container>
</template>

<script>
import Ajax from '~/config/ajax'
import AlertIcon from '~/components/common/alert-icon'
import NamespaceDialog from '~/components/dialogs/namespace-dialog'
import DataElementDialog from '~/components/dialogs/data-element-dialog'
import GroupRecordDialog from '~/components/dialogs/group-record-dialog'
import DataElementDetailView from '~/components/views/data-element-detail-view.vue'
import GroupsRecordsDetailView from '~/components/views/groups-records-detail-view'
import NamespaceDetailView from '~/components/views/namespace-detail-view.vue'
import DefaultSnackbar from '~/components/snackbars/default-snackbar'

export default {
  auth: false,
  components: {
    AlertIcon,
    NamespaceDialog,
    DataElementDialog,
    GroupRecordDialog,
    DataElementDetailView,
    NamespaceDetailView,
    GroupsRecordsDetailView,
    DefaultSnackbar
  },
  data: () => ({
    componentKey: 0,
    itemId: -1,
    ajax: {
      namespaceUrl: process.env.mdrBackendUrl + '/v1/namespaces/',
      elementUrl: process.env.mdrBackendUrl + '/v1/element/'
    },
    dialog: {
      urn: '',
      showNamespace: false,
      showDataElement: false,
      showDataElementGroup: false,
      elementType: 'None',
      namespaceUrn: '',
      parentUrn: '',
      response: {}
    },
    snackbar: {
      deleteFailure: false,
      deleteSuccess: false,
      saveFailure: false,
      saveSuccess: false
    },
    treeItems: [],
    openNodes: [],
    activeElements: [],
    selectedElement: null,
    valueDomainIsFetching: true
  }),
  computed: {
    selected () {
      if (!this.activeElements.length) {
        return undefined
      }
      return this.selectedElement
    },
    loggedIn () {
      return this.$auth.loggedIn
    }
  },
  watch: {
    activeElements () {
      if (typeof this.activeElements[0] !== 'undefined') {
        if (this.selectedElement === null) {
          this.fetchElement(this.activeElements.slice(-1)[0].urn)
        } else if (this.selectedElement.identification.urn !== this.activeElements.slice(-1)[0].urn) {
          this.fetchElement(this.activeElements.slice(-1)[0].urn)
        }
      }
    },
    'dialog.show' () {
      if (this.dialog.show === false) {
        this.refreshTree()
      }
    }
  },
  mounted () {
    this.fetchNamespaces()
    const findAnd = require('find-and')
    this.$root.$on('changeActiveElement', (urn) => {
      const item = findAnd.returnFound(this.treeItems, { urn })
      this.activeElements = []
      this.activeElements.unshift(item)
      this.setActiveElements(this.activeElements)
    })
  },
  methods: {
    updateTree (element) {
      this.$log.debug('Element saved now update the Tree ...')
      this.$log.debug(element)
      const findAnd = require('find-and')
      const item = {
        id: this.generateItemId(),
        urn: element.identification.urn,
        editable: element.identification.status.toUpperCase() !== 'OUTDATED',
        name: element.definitions[0].designation,
        elementType: element.identification.elementType,
        children: element.identification.elementType === 'DATAELEMENT' ? undefined : [],
        isPreferredLanguage: Ajax.preferredLanguage.includes(element.definitions[0].language)
      }
      switch (element.identification.elementType) {
        case 'NAMESPACE': {
          if (element.action === 'CREATE') {
            item.children = []
            this.treeItems.push(item)
          } else if (element.action === 'UPDATE') {
            const previousItem = findAnd.returnFound(this.treeItems, { urn: element.previousUrn })
            item.children = previousItem.children
            this.treeItems = findAnd.replaceObject(this.treeItems, { urn: element.previousUrn }, item)
          } else {
            this.treeItems = findAnd.removeObject(this.treeItems, { urn: element.identification.urn })
          }
          break
        }
        case 'RECORD':
        case 'DATAELEMENTGROUP': {
          this.fetchMembers(item)
        }
        // fallthrough
        case 'DATAELEMENT': {
          if (element.action === 'CREATE') {
            const parentElement = findAnd.returnFound(this.treeItems, { urn: this.dialog.parentUrn })
            parentElement.children.push(item)
            this.treeItems = findAnd.replaceObject(this.treeItems, { urn: this.dialog.parentUrn }, parentElement)
          } else if (element.action === 'UPDATE') {
            const currentElement = findAnd.returnFound(this.treeItems, { urn: element.previousUrn })
            item.id = currentElement.id
            this.treeItems = findAnd.replaceObject(this.treeItems, { urn: element.previousUrn }, item)
          } else {
            this.treeItems = findAnd.removeObject(this.treeItems, { urn: element.identification.urn })
          }
          break
        }
      }
    },
    async fetchNamespaces () {
      await this.$axios.$get(this.ajax.namespaceUrl)
        .then(function (res) {
          this.treeItems = []
          let namespaces
          namespaces = Array.from(res.READ)
          if (res.ADMIN) {
            namespaces = Array.from(namespaces.concat(res.ADMIN, res.WRITE))
          }
          for (const namespace of namespaces) {
            if (namespace.identification.status !== 'OUTDATED') {
              this.treeItems.push({
                id: this.generateItemId(),
                urn: namespace.identification.urn,
                isPreferredLanguage: Ajax.preferredLanguage.includes(namespace.definitions[0].language),
                editable: !res.READ.includes(namespace),
                name: namespace.definitions[0].designation,
                elementType: 'NAMESPACE',
                children: []
              })
            }
          }
        }.bind(this))
    },
    async fetchMembers (element) {
      this.$log.debug('Fetching members ...')
      this.$log.debug(element)
      const findAnd = require('find-and')
      await this.$axios.$get(!this.isNamespace(element.urn)
        ? this.ajax.elementUrl + element.urn +
        '/members'
        : this.ajax.namespaceUrl + element.urn.split(':')[3] +
        '/members?hideSubElements=true', Ajax.header.listView)
        .then(function (res) {
          const members = []
          for (const member of Array.from(res)) {
            let urn
            let elementType
            if (!this.isNamespace(element.urn)) {
              elementType = member.urn.split(':')[2].toUpperCase()
              urn = member.urn.toLowerCase()
            } else {
              elementType = member.elementType.toUpperCase()
              urn = 'urn:' + element.urn.split(':')[1] + ':' +
                member.elementType.toLowerCase() + ':' + member.identifier + ':' + member.revision
            }
            if (member.status !== 'OUTDATED') {
              members.push({
                id: this.generateItemId(),
                parentUrn: element.urn,
                urn,
                editable: this.getNamespace(urn).editable,
                isPreferredLanguage: Ajax.preferredLanguage.includes(member.definitions[0].language),
                name: member.definitions[0].designation,
                elementType,
                children: elementType === 'DATAELEMENT' ? undefined : []
              })
            }
          }
          this.setActiveElements(this.activeElements)
          this.treeItems =
            findAnd.changeProps(this.treeItems, { urn: element.urn }, { children: members })
          return members
        }.bind(this))
    },
    async fetchElement (urn) {
      await this.$axios.$get(!this.isNamespace(urn)
        ? this.ajax.elementUrl + urn
        : this.ajax.namespaceUrl + urn.split(':')[1],
      {
        headers: {
          'Accept-Language': ''
        }
      })
        .then(function (res) {
          if
          (!['ENUMERATED_VALUE_DOMAIN', 'DESCRIBED_VALUE_DOMAIN']
            .includes(res.identification.elementType)) {
            res.editable = this.getNamespace(urn).editable && res.identification.status.toUpperCase() !== 'OUTDATED'
            this.selectedElement = res
            if (this.selectedElement.identification.elementType === 'DATAELEMENT') {
              this.valueDomainIsFetching = true
              this.fetchElement(this.selectedElement.valueDomainUrn)
            }
          } else {
            this.selectedElement.valueDomain = res
            this.valueDomainIsFetching = false
          }
        }.bind(this))
    },
    isNamespace (urn) {
      return urn.toUpperCase().includes('NAMESPACE')
    },
    elementToBeCreated (elementType, parentUrn) {
      const namespaceUrn = this.getNamespace(parentUrn).urn
      this.dialog.elementType = elementType
      this.dialog.namespaceUrn = namespaceUrn
      this.dialog.namespaceDesignation = this.treeItems.find(elem => elem.urn === namespaceUrn).name
      switch (elementType) {
        case 'NAMESPACE':
          this.dialog.showNamespace = true
          break
        case 'DATAELEMENT':
          this.dialog.showDataElement = true
          break
        case 'DATAELEMENTGROUP':
        case 'RECORD':
          this.dialog.showDataElementGroup = true
          break
        default:
          this.$log.debug('Element type could not be determined.')
          break
      }
      this.dialog.parentUrn = parentUrn
    },
    getNamespace (urn) {
      const namespaceIdentifier = urn.split(':')[1]
      return this.isNamespace(urn)
        ? this.treeItems.find(elem => elem.urn === urn)
        : this.treeItems.find(elem => elem.urn.split(':')[1] ===
          namespaceIdentifier)
    },
    generateItemId () {
      this.itemId = this.itemId + 1
      return this.itemId
    },
    setActiveElements (elements) {
      const findAnd = require('find-and')
      if (elements.length < this.activeElements.length) {
        this.activeElements = []
        return
      }
      if (elements.length > 0) {
        const activeItems =
          findAnd.returnFound(this.treeItems, { urn: elements.slice(-1)[0].urn })
        this.activeElements = Array.isArray(activeItems) ? activeItems : [activeItems]
      } else {
        this.activeElements = []
      }
    },
    async showSaveSuccessSnackbar () {
      this.snackbar.saveSuccess = true
      await new Promise(resolve => setTimeout(resolve, 2000))
      this.snackbar.saveSuccess = false
    },
    async showDeleteSuccessSnackbar () {
      this.snackbar.deleteSuccess = true
      await new Promise(resolve => setTimeout(resolve, 2000))
      this.snackbar.deleteSuccess = false
    },
    async handleSaveFailure (response) {
      this.dialog.response = response
      this.snackbar.saveFailure = true
      await new Promise(resolve => setTimeout(resolve, 3500))
      this.snackbar.saveFailure = false
    },
    async handleDeleteFailure (response) {
      this.dialog.response = response
      this.snackbar.deleteFailure = true
      await new Promise(resolve => setTimeout(resolve, 3500))
      this.snackbar.deleteFailure = false
    }
  }
}
</script>

<style>
.fill-parent-height {
  height: 100%;
}

.tree-view-col {
  height: 100%;
  background-color: #a4c2da;
}

.create-namespace-col {
  background-color: #a4c2da;
}

.detail-view-col {
  height: 100%;
  background-color: #eaf3fa;
}

.auto-scroll {
  overflow-y: auto;
}

.auto-scroll > p {
  height: 9000px;
}

.bottom-row {
  width: 100%;
  min-height: 0;
}

.top-row {
  width: 100%;
}

.top-col {
  height: 60px;
}

</style>
